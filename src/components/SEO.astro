---
import { SOCIAL_LINKS, PROFESSIONAL_INFO, ABOUT_ME } from "../config/constants";

export interface Props {
  title: string;
  description: string;
  image: string;
  publishDate?: Date;
  type?: "website" | "article";
  url?: string;
}

const { title, description, image, type = "website", publishDate, url } = Astro.props;

// Ensure absolute URLs for social sharing
const siteUrl = Astro.site?.toString() || "https://omrilavi.com";
const canonicalUrl = url || Astro.url.toString();
const absoluteImage = image.startsWith("http") ? image : new URL(image, siteUrl).toString();

// Auto-derive OG image path: /blog-assets/foo.avif â†’ /blog-assets/foo-og.jpg
function deriveOgImagePath(imagePath: string): string {
  const supportedExtensions = [".avif", ".webp"];
  const ext = imagePath.match(/\.[^.]+$/)?.[0]?.toLowerCase() || "";
  if (!supportedExtensions.includes(ext)) {
    return imagePath; // Already JPG/PNG, use as-is
  }
  return imagePath.replace(/\.[^.]+$/, "-og.jpg");
}

const socialImage = new URL(deriveOgImagePath(image), siteUrl).toString();

// Structured data for homepage
const websiteStructuredData = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: PROFESSIONAL_INFO.name,
  url: siteUrl,
  image: new URL("/me.avif", siteUrl).toString(),
  jobTitle: `${PROFESSIONAL_INFO.jobTitle} at ${PROFESSIONAL_INFO.company}`,
  description: ABOUT_ME.description,
  sameAs: Object.values(SOCIAL_LINKS),
};

// Structured data for blog posts
const articleStructuredData = publishDate
  ? {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      headline: title,
      description: description,
      image: absoluteImage,
      author: {
        "@type": "Person",
        name: PROFESSIONAL_INFO.name,
        url: siteUrl,
      },
      publisher: {
        "@type": "Person",
        name: PROFESSIONAL_INFO.name,
        url: siteUrl,
      },
      datePublished: publishDate,
      dateModified: publishDate,
      mainEntityOfPage: {
        "@type": "WebPage",
        "@id": canonicalUrl,
      },
    }
  : null;

const structuredData = type === "article" && articleStructuredData ? articleStructuredData : websiteStructuredData;
---

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<link rel="canonical" href={canonicalUrl} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={socialImage} />
<meta property="og:site_name" content={PROFESSIONAL_INFO.fullTitle} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalUrl} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={socialImage} />
<meta property="twitter:creator" content={PROFESSIONAL_INFO.twitterHandle} />

<!-- Article specific meta tags -->
{
  publishDate && (
    <>
      <meta property="article:published_time" content={publishDate.toISOString()} />
      <meta property="article:author" content={PROFESSIONAL_INFO.name} />
    </>
  )
}

<!-- Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
